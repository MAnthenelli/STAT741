---
title: "Untitled"
author: "Max Anthenelli"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
## set working directory ----
working_directory <- file.path("C:", "Users", "Max", "Documents", "GitHub",
                                "STAT741")
setwd(working_directory)

## choose required packages ----
c("tidyverse", "magrittr", "rlang", "glue",
  "haven", "labelled",
  "lme4", "steps", "gt", "gtsummary", "webshot2", 
  "scales", "grid", "ggtext", "patchwork"
) |>
purrr::walk(~require(.x, character.only = TRUE))


family_asthma <- read_dta('family_asthma.dta')

long_vars <- c('age', 'smk', 'cncig', 'fvc', 'fev')

pivot_long_repeat_vars <- 
  function(var){
  df_name <- glue("family_asthma_long_{var}")
  message(glue("reshaping {df_name}"))
  var_name <- ensym(var)
  df <- 
    family_asthma %>%   
    pivot_longer(cols = starts_with(var),
                 names_to = 'year',
                 names_prefix = var, 
                 values_to = var,
                 values_drop_na = TRUE,
                 names_repair = 'unique') %>% 
  select(id, year, all_of(var))
  assign(df_name, df, envir = .GlobalEnv)
  }
          
walk(long_vars, ~pivot_long_repeat_vars(.x))

family_asthma_long <- 
  family_asthma_long_fev %>%
  full_join(family_asthma_long_cncig, by = c("id", "year")) %>%
  full_join(family_asthma_long_smk, by = c("id", "year")) %>% 
  full_join(family_asthma_long_fvc, by = c("id", "year")) %>% 
  full_join(family_asthma_long_age, by = c("id", "year")) %>% 
  left_join(family_asthma %>% rename(smoke_ever = smkever) %>%
  select(!starts_with(long_vars)), by = c("id")) %>% 
  mutate(year =  parse_number(year),
         cncig = ifelse(smoke_ever == 0, 0 , cncig))

```
The primary research questions are as follows:
1. Do asthmatics have steeper rates of decline (slope) or lower levels of lung function
(FEV1) than non-asthmatics, independent of smoking history?
regress fev on time for non-asthmatics

```{r message=FALSE}
family_asthma_long %>% 
lmer(fev ~ year + year:asthma + asthma + (1 | family) + ( year || id) , data = .) %>% 
tbl_regression(estimate_fun = partial(style_ratio, digits = 3),
               style_pvalue = function(x) style_pvalue(x, digits = 2),
               conf.int = FALSE) %>% 
  add_global_p()
```


2. Do asthmatic smokers have steeper rates of decline or lower levels of lung function
than non-asthmatic smokers? Here you can explore three options 1) using the fixed effect
variable ever smoke, 2) using the time dependent variable for smoking, or 3) using the
current number of cigarettes per day. When using this I would suggest making it a
categorical variable using quartiles etc.


```{r message = FALSE}
var_label(family_asthma_long$smoke_ever) <- "Ever Smoked"

family_asthma_long %>% 
  lmer(fev ~ year + year:asthma + asthma + smoke_ever +
       (1 | family) + (year || id) , data = .) %>%
  tbl_regression(estimate_fun = partial(style_ratio, digits = 3),
               style_pvalue = function(x) style_pvalue(x, digits = 2),
               conf.int = FALSE) %>% 
  add_global_p()

family_asthma_long %>% 
  lmer(fev ~ year + year:asthma + asthma + smk +
       (1 | family) + (year || id) , data = .) %>%
  tbl_regression(estimate_fun = partial(style_ratio, digits = 3),
               style_pvalue = function(x) style_pvalue(x, digits = 2),
               conf.int = FALSE) %>% 
  add_global_p()

family_asthma_long %>% 
  lmer(fev ~ year + year:asthma + asthma + smk +
       (1 | family) + ( 1 | id) , data = .) %>%
  tbl_regression(estimate_fun = partial(style_ratio, digits = 3),
               style_pvalue = function(x) style_pvalue(x, digits = 2),
               conf.int = FALSE) %>% 
  add_global_p()
```

Hints:
1. When random effects are nested, the order in which they are listed is important. The
order in which they are specified (from left to right) is significant â€“ xtmixed assumes that
the second factor is nested in the first. In this data subjects (id) are nested within
Families (family).
2. Subjects should be tested for a RCM with age but families should not, any adjustment
for serial correlation with time done at the subject level would also remove it at the
family level.

Notes:
 
1.  Both subject (id) and subject by age, and family (family) should be considered as potential random effects (i.e. fit a RCM)
2. Be sure to select the optimal covariance pattern for your random effects.
2. Plot resulting mean curves whenever you can to demonstrate significant effects.
3. It is not necessary to test higher order polynomials in either the fixed or random effects.
4. Be sure to provide residual plots, normal probability plots for any random effects, and to test for serial correlation in residuals.
5. Lung function measures generally need to be adjusted for anthropometric measures height and sex.